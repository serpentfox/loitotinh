<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat - L·ªùi t·ªè t√¨nh</title>
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
       // THAY "YOUR_PUBLIC_KEY" b·∫±ng Public Key c·ªßa b·∫°n t·ª´ EmailJS
       emailjs.init("Bzi9P47YstvP6dCoF");
    })();
  </script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h3>Tin nh·∫Øn</h3>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message other">
        <img src="assets/avatar2.png" alt="Anh" class="avatar" />
        <p>Ch√†o em, anh ƒëang r·∫•t h·ªìi h·ªôp khi g·ª≠i ƒëi·ªÅu n√†y...</p>
      </div>
      <div class="message other">
        <img src="assets/avatar2.png" alt="Anh" class="avatar" />
        <p>Emm c√≥ mu·ªën n√≥i chuy·ªán v·ªõi anh kh√¥ng?</p>
      </div>
      <div class="message user">
        <img src="assets/avatar1.png" alt="Em" class="avatar" />
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Nh·∫≠p c√¢u n√≥i ti·∫øp theo..." />
    </div>
    <div id="proposal" class="proposal hidden">
      <p>Em c√≥ mu·ªën l√†m em b√© c·ªßa anh kh√¥ng?</p>
      <div class="proposal-buttons">
        <button id="agreeBtn">ƒê·ªìng √Ω</button>
        <button id="declineBtn">T·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const messages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const proposal = document.getElementById("proposal");
      const agreeBtn = document.getElementById("agreeBtn");
      const declineBtn = document.getElementById("declineBtn");

      const responses = [
        "Anh th·∫•y em n√≥i chuy·ªán r·∫•t ƒë√°ng y√™u.",
        "C·ª© n√≥i ti·∫øp ƒëi, anh nghe m√† tim ƒë·∫≠p nhanh l√™n.",
        "Em th·∫•y anh c·∫ßn s·ª≠a ƒëi·ªÅu g√¨ khi y√™u em kh√¥ng ",
        "Anh ch·ªâ c·∫ßn em ·ªü ƒë√¢y, d√π ch·ªâ l√† m·ªôt tin nh·∫Øn.",
        "Em n√≥i g√¨ anh c≈©ng mu·ªën nghe c·∫£ ƒë·ªùi.",
        "Anhh h√¥ngg n√≥i l√† m√¨nh t·ªët nh∆∞ng anhh s·∫Ω khong t·ªìi khi b√™n em ƒë√¢uu",
        "Anh c≈©ng mu·ªën ƒë∆∞·ª£c l√† ng∆∞·ªùi ƒë∆∞·ª£c y√™u √Ω",
        "Anh nghƒ© em l√† ng∆∞·ªùi duy nh·∫•t khi·∫øn anh c·∫£m th·∫•y an to√†n.",
        "Anh mu·ªën ƒë∆∞·ª£c ·ªü b√™n em m·ªói ng√†y, k·ªÉ c·∫£ khi kh√¥ng n√≥i g√¨.",
        "Em c√≥ th·ªÉ cho anh c∆° h·ªôi ƒë∆∞·ª£c kh√¥ng "
      ];

      let userMessageCount = 3;

      function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "message other typing";
        typingDiv.innerHTML = `
          <img src="assets/avatar2.png" alt="Anh" class="avatar" />
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        messages.appendChild(typingDiv);
        messages.scrollTop = messages.scrollHeight;
        return typingDiv;
      }

      function removeTypingIndicator(typingDiv) {
        typingDiv.remove();
      }

      function typeText(element, text, delay = 50) {
        let i = 0;
        element.textContent = "";
        const timer = setInterval(() => {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
          } else {
            clearInterval(timer);
          }
        }, delay);
      }

      function sendResponse(text) {
        const typingDiv = showTypingIndicator();
        setTimeout(() => {
          removeTypingIndicator(typingDiv);
          const otherMsg = document.createElement("div");
          otherMsg.className = "message other";
          otherMsg.innerHTML = `
            <img src="assets/avatar2.png" alt="Anh" class="avatar" />
            <p></p>
          `;
          messages.appendChild(otherMsg);
          messages.scrollTop = messages.scrollHeight;
          const p = otherMsg.querySelector("p");
          typeText(p, text, 40);
        }, 1000);
      }

      messageInput?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const text = messageInput.value.trim();
          if (!text) return;

          const userMsg = document.createElement("div");
          userMsg.className = "message user";
          userMsg.innerHTML = `
            <img src="assets/avatar1.png" alt="Em" class="avatar" />
            <p>${text}</p>
          `;
          messages.appendChild(userMsg);
          messages.scrollTop = messages.scrollHeight;

          userMessageCount++;

          const responseIndex = userMessageCount - 4;
          if (responseIndex < responses.length) {
            sendResponse(responses[responseIndex]);
          }

          messageInput.value = "";

          if (userMessageCount === 10) {
            proposal.classList.remove("hidden");
            messageInput.disabled = true;
          }
        }
      });

      // H√†m g·ª≠i Email d√πng chung
      function sendDecisionEmail(isAgreed) {
        const username = localStorage.getItem("username") || "Ng∆∞·ªùi d√πng";
        const status = isAgreed ? "ƒê·ªíNG √ù üòç" : "T·ª™ CH·ªêI üíî";
        const messageBody = isAgreed 
          ? "Ng∆∞·ªùi d√πng ƒë√£ ƒë·ªìng √Ω l√†m em b√© c·ªßa anh! üòç" 
          : "Ng∆∞·ªùi d√πng ƒë√£ t·ª´ ch·ªëi l·ªùi c·∫ßu h√¥n. Anh hi·ªÉu m√†... C·∫£m ∆°n em v√¨ ƒë√£ d√†nh th·ªùi gian cho anh.";

        const templateParams = {
          to_email: "foxgaming@0504gmail.com",
          from_name: username,
          message: messageBody,
          to_name: "Ng∆∞·ªùi y√™u",
          subject: `üîî K·∫øt qu·∫£: ${status}`
        };

        // THAY "YOUR_SERVICE_ID" v√† "YOUR_TEMPLATE_ID" cho ƒë√∫ng
        emailjs.send("service_m6k98wm", "template_jhsawxg", templateParams)
          .then(() => {
            alert("üíå K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!");
          })
          .catch((err) => {
            alert("‚ùå L·ªói g·ª≠i email: " + JSON.stringify(err));
          });
      }

      // ‚úÖ X·ª≠ l√Ω khi ch·ªçn "ƒê·ªìng √Ω"
      agreeBtn?.addEventListener("click", () => {
        sendDecisionEmail(true);
        agreeBtn.disabled = true;
        declineBtn.disabled = true;
      });

      // ‚úÖ X·ª≠ l√Ω khi ch·ªçn "T·ª´ ch·ªëi"
      declineBtn?.addEventListener("click", () => {
        sendDecisionEmail(false);
        agreeBtn.disabled = true;
        declineBtn.disabled = true;
      });

    });
  </script>
</body>
</html>
