<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat - L·ªùi t·ªè t√¨nh</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h3>Tin nh·∫Øn</h3>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message other">
        <img src="assets/avatar2.png" alt="Anh" class="avatar" />
        <p>Ch√†o em, anh ƒëang r·∫•t h·ªìi h·ªôp khi g·ª≠i ƒëi·ªÅu n√†y...</p>
      </div>
      <div class="message other">
        <img src="assets/avatar2.png" alt="Anh" class="avatar" />
             </div>
      <div class="message user">
        <img src="assets/avatar1.png" alt="Em" class="avatar" />
        <p>·ª™m, anh ƒëang n√≥i g√¨ v·∫≠y?</p>
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Nh·∫≠p c√¢u n√≥i ti·∫øp theo..." />
    </div>
    <div id="proposal" class="proposal hidden">
      <p>Em c√≥ mu·ªën l√†m em b√© c·ªßa anh kh√¥ng?</p>
      <div class="proposal-buttons">
        <button id="agreeBtn">ƒê·ªìng √Ω</button>
        <button id="declineBtn">T·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const messages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const proposal = document.getElementById("proposal");
      const agreeBtn = document.getElementById("agreeBtn");
      const declineBtn = document.getElementById("declineBtn");

      const responses = [
        "Anh th·∫•y em n√≥i chuy·ªán r·∫•t ƒë√°ng y√™u.",
        "em c√≥ th·∫•y anhh b√™n em l√† ·ªïn h√¥ng.",
        "Em c√≥ mu·ªën anh l√†m ng∆∞·ªùi b√™n em m·ªói ng√†yy h√¥m",
        "em c√≥ y√™u c·∫ßu g√¨ khi anh ·ªü b√™n em h√¥ng.",
        "Em n√≥i g√¨ anh c≈©ng mu·ªën nghe c·∫£ ƒë·ªùi.",
        "emm c√≥ tinn t∆∞·ªüng anhh h√¥ngg hay c√≤n nghi ng·ªù anh ƒë·∫•y.",
        "anhh kh√¥ng h·ª©a m√¨nh t·ªët nh∆∞ng anh s·∫Ω c·ªë g·∫Øng ƒë·ªÉ t·ªët khi b√™n em.",
        "em c√≥ nghƒ© anh l√† ng∆∞·ªùi duy nh·∫•t khi·∫øn anh c·∫£m th·∫•y an to√†n.",
        "Anh mu·ªën ƒë∆∞·ª£c ·ªü b√™n em m·ªói ng√†y, k·ªÉ c·∫£ khi kh√¥ng n√≥i g√¨.",
        "Em cho anh c∆° h·ªôi ƒë∆∞·ª£c ·ªü b√™n em nh√© <3 "
      ];

      let userMessageCount = 3;

      function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "message other typing";
        typingDiv.innerHTML = `
          <img src="assets/avatar2.png" alt="Anh" class="avatar" />
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        messages.appendChild(typingDiv);
        messages.scrollTop = messages.scrollHeight;
        return typingDiv;
      }

      function removeTypingIndicator(typingDiv) {
        typingDiv.remove();
      }

      function typeText(element, text, delay = 50) {
        let i = 0;
        element.textContent = "";
        const timer = setInterval(() => {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
          } else {
            clearInterval(timer);
          }
        }, delay);
      }

      function sendResponse(text) {
        const typingDiv = showTypingIndicator();
        setTimeout(() => {
          removeTypingIndicator(typingDiv);
          const otherMsg = document.createElement("div");
          otherMsg.className = "message other";
          otherMsg.innerHTML = `
            <img src="assets/avatar2.png" alt="Anh" class="avatar" />
            <p></p>
          `;
          messages.appendChild(otherMsg);
          messages.scrollTop = messages.scrollHeight;
          const p = otherMsg.querySelector("p");
          typeText(p, text, 40);
          saveChat(text, "other"); // L∆∞u v√†o localStorage
        }, 1000);
      }

      messageInput?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const text = messageInput.value.trim();
          if (!text) return;

          const userMsg = document.createElement("div");
          userMsg.className = "message user";
          userMsg.innerHTML = `
            <img src="assets/avatar1.png" alt="Em" class="avatar" />
            <p>${text}</p>
          `;
          messages.appendChild(userMsg);
          messages.scrollTop = messages.scrollHeight;
          saveChat(text, "user"); // L∆∞u v√†o localStorage

          userMessageCount++;

          const responseIndex = userMessageCount - 4;
          if (responseIndex < responses.length) {
            sendResponse(responses[responseIndex]);
          }

          messageInput.value = "";

          if (userMessageCount === 10) {
            proposal.classList.remove("hidden");
            messageInput.disabled = true;
          }
        }
      });
      // ‚úÖ G·ª≠i email khi ng∆∞·ªùi d√πng ch·ªçn "ƒê·ªìng √Ω"
      agreeBtn?.addEventListener("click", () => {
        const username = localStorage.getItem("username") || "Ng∆∞·ªùi d√πng";
        const message = "Ng∆∞·ªùi d√πng ƒë√£ ƒë·ªìng √Ω l√†m em b√© c·ªßa anh! üòç";

        // ‚úÖ G·ª¨I EMAIL B·∫∞NG EMAILJS
        emailjs.send("service_m6k98wm", "service_m6k98wm", {
          to_email: "foxgaming0504@gmail.com", // üëà THAY B·∫∞NG EMAIL C·ª¶A B·∫†N
          from_name: username,
          message: message,
          to_name: "Ng∆∞·ªùi y√™u",
          subject: "üîî Ng∆∞·ªùi d√πng ƒë√£ ƒë·ªìng √Ω y√™u anh!"
        }).then(() => {
          alert("üíå L·ªùi c·∫ßu h√¥n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!");
        }).catch((err) => {
          alert("‚ùå L·ªói g·ª≠i email: " + JSON.stringify(err));
        });

        agreeBtn.disabled = true;
        declineBtn.disabled = true;
      });

      // ‚úÖ G·ª≠i email khi ng∆∞·ªùi d√πng ch·ªçn "T·ª´ ch·ªëi"
      declineBtn?.addEventListener("click", () => {
        const username = localStorage.getItem("username") || "Ng∆∞·ªùi d√πng";
        const message = "Ng∆∞·ªùi d√πng ƒë√£ t·ª´ ch·ªëi l·ªùi c·∫ßu h√¥n. Anh hi·ªÉu m√†... C·∫£m ∆°n em v√¨ ƒë√£ d√†nh th·ªùi gian cho anh.";

        // ‚úÖ G·ª¨I EMAIL B·∫∞NG EMAILJS
        emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
          to_email: "your-email@gmail.com", // üëà THAY B·∫∞NG EMAIL C·ª¶A B·∫†N
          from_name: username,
          message: message,
          to_name: "Ng∆∞·ªùi y√™u",
          subject: "üíî Ng∆∞·ªùi d√πng ƒë√£ t·ª´ ch·ªëi y√™u anh!"
        }).then(() => {
          alert("üíå Th√¥ng b√°o t·ª´ ch·ªëi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!");
        }).catch((err) => {
          alert("‚ùå L·ªói g·ª≠i email: " + JSON.stringify(err));
        });

        agreeBtn.disabled = true;
        declineBtn.disabled = true;
      });

