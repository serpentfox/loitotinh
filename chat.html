<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat - L·ªùi t·ªè t√¨nh</title>
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
       // THAY "YOUR_PUBLIC_KEY" b·∫±ng m√£ c·ªßa b·∫°n
       emailjs.init("Bzi9P47YstvP6dCoF");
    })();
  </script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h3>Tin nh·∫Øn</h3>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message other">
        <img src="assets/avatar2.png" alt="Anh" class="avatar" />
        <p>Ch√†o em, anh ƒëang r·∫•t h·ªìi h·ªôp khi g·ª≠i ƒëi·ªÅu n√†y...</p>
      </div>
      <div class="message other">
        <img src="assets/avatar2.jpg" alt="Anh" class="avatar" />
        <p>Emm c√≥ mu·ªën n√≥i chuy·ªán v·ªõi anh kh√¥ng?</p>
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Nh·∫≠p c√¢u n√≥i ti·∫øp theo..." />
    </div>
    <div id="proposal" class="proposal hidden">
      <p>Em c√≥ mu·ªën l√†m em b√© c·ªßa anh kh√¥ng?</p>
      <div class="proposal-buttons">
        <button id="agreeBtn">ƒê·ªìng √Ω</button>
        <button id="declineBtn">T·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const messages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const proposal = document.getElementById("proposal");
      const agreeBtn = document.getElementById("agreeBtn");
      const declineBtn = document.getElementById("declineBtn");

      // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ to√†n b·ªô n·ªôi dung chat d∆∞·ªõi d·∫°ng vƒÉn b·∫£n
      let fullChatHistory = "L·ªäCH S·ª¨ TR√í CHUY·ªÜN:\n";
      fullChatHistory += "Anh: Ch√†o em, anh ƒëang r·∫•t h·ªìi h·ªôp khi g·ª≠i ƒëi·ªÅu n√†y...\n";
      fullChatHistory += "Anh: Emm c√≥ mu·ªën n√≥i chuy·ªán v·ªõi anh kh√¥ng?\n";

      const responses = [
        "Anh th·∫•y em n√≥i chuy·ªán r·∫•t ƒë√°ng y√™u.",
        "C·ª© n√≥i ti·∫øp ƒëi, anh nghe m√† tim ƒë·∫≠p nhanh l√™n.",
        "Em th·∫•y anh c·∫ßn s·ª≠a ƒëi·ªÅu g√¨ khi y√™u em kh√¥ng ",
        "Anh ch·ªâ c·∫ßn em ·ªü ƒë√¢y, d√π ch·ªâ l√† m·ªôt tin nh·∫Øn.",
        "Em n√≥i g√¨ anh c≈©ng mu·ªën nghe c·∫£ ƒë·ªùi.",
        "Anhh h√¥ngg n√≥i l√† m√¨nh t·ªët nh∆∞ng anhh s·∫Ω khong t·ªìi khi b√™n em ƒë√¢uu",
        "Anh c≈©ng mu·ªën ƒë∆∞·ª£c l√† ng∆∞·ªùi ƒë∆∞·ª£c y√™u √Ω",
        "Anh nghƒ© em l√† ng∆∞·ªùi duy nh·∫•t khi·∫øn anh c·∫£m th·∫•y an to√†n.",
        "Anh mu·ªën ƒë∆∞·ª£c ·ªü b√™n em m·ªói ng√†y, k·ªÉ c·∫£ khi kh√¥ng n√≥i g√¨.",
        "Em c√≥ th·ªÉ cho anh c∆° h·ªôi ƒë∆∞·ª£c kh√¥ng "
      ];

      let userMessageCount = 3;

      function sendResponse(text) {
        // ... (gi·ªØ nguy√™n logic hi·ªÉn th·ªã typing indicator nh∆∞ c≈©)
        setTimeout(() => {
          const otherMsg = document.createElement("div");
          otherMsg.className = "message other";
          otherMsg.innerHTML = `<img src="assets/avatar2.png" alt="Anh" class="avatar" /><p>${text}</p>`;
          messages.appendChild(otherMsg);
          messages.scrollTop = messages.scrollHeight;
          
          // L∆∞u v√†o l·ªãch s·ª≠ g·ª≠i mail
          fullChatHistory += "Anh: " + text + "\n";
        }, 1000);
      }

      messageInput?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const text = messageInput.value.trim();
          if (!text) return;

          const userMsg = document.createElement("div");
          userMsg.className = "message user";
          userMsg.innerHTML = `<img src="assets/avatar1.png" alt="Em" class="avatar" /><p>${text}</p>`;
          messages.appendChild(userMsg);
          
          // L∆∞u v√†o l·ªãch s·ª≠ g·ª≠i mail
          fullChatHistory += "Em: " + text + "\n";

          userMessageCount++;
          const responseIndex = userMessageCount - 4;
          if (responseIndex < responses.length) {
            sendResponse(responses[responseIndex]);
          }

          messageInput.value = "";
          if (userMessageCount === 10) {
            proposal.classList.remove("hidden");
            messageInput.disabled = true;
          }
        }
      });

      // ‚úÖ H√†m g·ª≠i Email ch·ª©a TO√ÄN B·ªò ƒêO·∫†N CHAT
      function finalSend(decision) {
        fullChatHistory += "\nK·∫æT QU·∫¢ CU·ªêI C√ôNG: " + decision;

        const templateParams = {
          to_email: "foxgaming@0504gmail.com",
          from_name: "H·ªá th·ªëng Chat",
          message: fullChatHistory, // G·ª≠i bi·∫øn ch·ª©a to√†n b·ªô tin nh·∫Øn ·ªü ƒë√¢y
          subject: "üîî Th√¥ng b√°o k·∫øt qu·∫£ v√† L·ªãch s·ª≠ Chat"
        };

        // THAY "YOUR_SERVICE_ID" v√† "YOUR_TEMPLATE_ID"
        emailjs.send("service_m6k98wm", "template_zzw2rju", templateParams)
          .then(() => alert("üíå ƒê√£ g·ª≠i k·∫øt qu·∫£ v√† l·ªãch s·ª≠ chat v·ªÅ email c·ªßa b·∫°n!"))
          .catch((err) => alert("‚ùå L·ªói: " + JSON.stringify(err)));
      }

      agreeBtn?.addEventListener("click", () => finalSend("ƒê·ªíNG √ù üòç"));
      declineBtn?.addEventListener("click", () => finalSend("T·ª™ CH·ªêI üíî"));
    });
  </script>
</body>
</html>

